---
title: Extracorporeal CPR for Refractory Out-of-Hospital Cardiac Arrest
subtitle: A Bayesian Perspective
author:
  - name: James M Brophy
    email: james.brophy@mcgill.ca
    affiliations: 
        - id: McGill University 
          name: McGill University Health Center
          department: Centre for Health Outcomes Research (CORE) 
          address: 5252 Boul. de Maisonneuve West Room 2B.37
          city: Montreal
          state: QC
          postal-code: H4A 3S5
    attributes:
        corresponding: true
    note: JMB is a research scholar supported by Les Fonds de Recherche Québec Santé
abstract: |
  A recent randomized clinical trial reported in patients with refractory out-of-hospital cardiac arrest, extracorporeal CPR and conventional CPR had similar effects on survival with a favorable neurologic outcome. Herein, it is examined whether a Bayesian perspective allows any additional insights into the interpretation of this trial.
keywords: 
  - extracorporeal CPR
  - Bayesian statistics
date: last-modified
bibliography: bibliography.bib
format:
  elsevier-pdf:
    keep-tex: true
    journal:
      name: To be determined
      formatting: preprint
      model: 3p
      cite-style: super
editor: 
  markdown: 
    wrap: 72
---

# Introduction

Out-of-hospital cardiac arrest is a frequent event and fortunately its
devastating consequences can be partially mitigated by rapid
commencement of basic life support with high-quality chest compressions
and external defibrillation (conventional cardiopulmonary resuscitation
(CPR)). However, there remains a substantial subset of individuals who
do not respond rapidly to these measures and whether more invasive
measures. Whether the addition of more aggressive measure including
extracorporeal CPR (the addition of extracorporeal membrane oxygenation
to standard advanced cardiac life support) can improve survival and
diminish anoxic brain injury is a current topic of research. The largest
randomized clinical trial (RCT) examining this question recently
published their results[@CPR2023a]. For the primary outcome, 30 day
survival without significant neurological deficit, the authors observed
an odds ratio of 1.4 (95% confidence interval, 0.5 to 3.5; P = 0.52) in
favor of extracorporeal CPR for leading to their conclusion "In patients
with refractory out-of-hospital cardiac arrest, extracorporeal CPR and
conventional CPR had similar effects on survival with a favorable
neurological outcome".[@CPR2023a]

This communication does not reiterate the many reasons to be wary of
null hypothesis significance testing (NHST), p values and confidence
intervals[@RN5420]. Rather it assumes the reader has perhaps heard that
Bayesian methods mirror our intuitive learning process and is curious
about its potential application to RCT interpretations.

Therefore the goal of this communication is to examine whether a
Bayesian perspective permits additional insights into the specific
clinical question regarding any added value of extracorporeal CPR
following an out-of-hospital arrest in patients refractory to standard
CPR.

# Methods

The data for the primary outcome, 30 day survival with intact
neurological status, based on an intention to treat (ITT) analysis was
abstracted from the original INCEPTION trial [@CPR2023a] and used for
the primary analysis. The ITT analysis has the advantage of minimizing
bias by preserving the prognostic balance afforded by randomization as
well as assuring the validity of the statistical analyses. ITT assesses
subjects based on the group they were initially (and randomly) allocated
to, regardless of whether or not they dropped out, were fully adhered to
the treatment or switched to an alternative treatment. ITT analyses can
therefore be seen as a conservative estimate which mirrors clinical
effectiveness. In contrast, a per protocol (PP) analysis involves a
comparison of treatment groups in a trial that includes only those
patients who completed the treatment they were originally allocated to.
Similarly an "as treated" analysis considers only which treatments
subjects received, regardless of their randomization status and protocol
adherence. While both PP and as-treated analyses alone may lead to bias,
in conjunction with an ITT analysis they may provide additional insights
into efficacy and have also been examined from a Bayesian perspective.

Bayesian analytical approaches provide a number of benefits over the
classical NHST approach, including parameter estimation accompanied by
direct probability statements about parameters of interest (herein the
risk of survival with intact neurological status), and the incorporation
prior knowledge [@BrophyCardio; @Zampieri].

These probability statements arise from the posterior distribution
according to the following equation:
$$ \text{Posterior}  = \frac{\text{Probability of the data} * \text{Prior}}{\text{Normalizing Constant}} $$

Therefore, in addition to the current data summarized by the probability
of the data (likelihood function) one requires a prior probability
distribution for each parameter. The mechanics of the Bayesian analyses
were performed using the Stan programming language [@stan] through the R
package rstanarm [@rstanarm] and fit a logistic regression model with a
single treatment parameter, $\theta$. Because our focus is the
interpretation of the INCEPTION trial alone, our primary analysis used
rstanarm's default vague parameter priors
($log(\theta) \sim Normal [0, 2.50]$, thereby assuring that the
posterior distribution is dominated by the observed INCEPTION data.

The robustness of the Bayesian approach is often assessed by sensitivity
analyses that examine the variation in the posterior probability as a
function of the choice of different prior distributions. Using prior
information also underscores the important advantage of Bayesian
analyses to learn sequentially. There were two previous RCTs examining
extracorporeal CPR[@RN6759][@RN6751] and while the protocols are not
identical, it may be reasonable to allow this data can serve as an
informed prior which can be updated with the INCEPTION data. This prior
information of the probability of success in each arm, $X_i$, can be summarized by a Beta distribution as follow
$$X_i\sim\mbox{Beta}(\alpha_0,\beta_0)$$ 
where in the context of Bernoulli trials, $\alpha$ can be interpreted as 1 + number of successes and $\beta$ can be interpreted as 1 + number of failures. The mean and variance of this distribution are 
$$\mu=\frac{\alpha}{\alpha+\beta}$$

$$\sigma^2=\frac{\alpha\beta}{(\alpha+\beta)^2(\alpha+\beta+1)}$$ where
$\alpha$ and $\beta$ are the number of successes and failures respectively. The difference between the two treatment arms of these previous studies can then serve as the prior information which in the Bayesian paradigm can be updated with the INCEPTION data to form a posterior distribution.    

Posterior distributions are summarized with medians and 95%
highest-density intervals (credible intervals), defined as the narrowest
interval containing 95% of the probability density function
[@mcelreath2020]. We not only calculated the posterior probability of
any benefit (OR \>1.00), but also of clinically meaningful benefits
(defined as OR \>1.10).

All analyses were executed within the integrated development environment
of RStudio and the statistical code can be found on Github
(https://github.com/brophyj/eCPR).

# Results

The ITT data from the three pertinent trials is shown in Table 1. Performing a Bayesian analysis on the INCEPTION trial, using a vague prior, produces an odds ratio 1.32 (95% Credible Interval (CrI) 0.54 - 3.22). The closeness of this result to the original analysis confirms the lack if impact of the vague prior and shows this Bayesian analysis is dominated by the observed data.

\newpage

```{r echo=FALSE,  message=FALSE, warning=FALSE, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = FALSE)
options(scipen = 1, digits = 3)
pander::panderOptions('keep.trailing.zeros', TRUE)

library(here)
library(tidyverse)
library(broom)
library(cobalt)
library(table1)
library(knitr)
library(patchwork)
library(rstanarm)
library(tidybayes)
library(gt)

```

# Tables

```{r}
df <- tibble(Trial = c("INCEPTION", "INCEPTION","ARREST", "ARREST", "PRAGUE", "PRAGUE"), Tx = c("CPR", "eCPR", "CPR", "eCPR", "CPR", "eCPR"),
             fail = c(52, 56, 15, 8, 108, 86),
             success = c(10,14, 0, 6,24,38 )) %>% 
  mutate(total = fail + success,
         prop_success = success / total) 
df1 <- df[, c(1:4)]  %>% tidyr::pivot_wider(names_from = Tx, values_from = c(fail,success))


knitr::kable(df1, caption = "Table 1 Extracted ITT trial data", col.names=c("Trial", "Fail CPR", "Fail eCPR", "Success CPR", "Success eCPR"))

#frequentist INCEPTION  to reproduce NEJM result
fit <- glm(prop_success ~ Tx, data = df[c(1:2),], family = binomial(link="logit"), weights = total)
# summary(fit, digits=3)
# print(c(exp(.262),exp(.262+c(-1,1)*1.96*.457)))
# [1] 1.300 0.531 3.183
```

# Bayesian analysis 

```{r cache=TRUE}
# - INCEPTION alone default vague priors
set.seed(1234)
fit1 <- stan_glm(prop_success ~ Tx, data = df[c(1:2),], family = binomial(link="logit"), weights = total, refresh=0) #stan_glm with combined prior
fit1_sum <- summary(fit1, digits=3)
conf_95 <- c(exp(fit1_sum[2]),exp(fit1_sum[2]+c(-1,1)*1.96*fit1_sum[10]))
tt <- fit1 %>%
    spread_draws(`(Intercept)`, `TxeCPR`)
fig_prob <- sum(tt$TxeCPR>0)/nrow(tt)
# summary(fit1, digits=3)
# print(c(exp(.2785),exp(.2785+c(-1,1)*1.96*.4537)))
# get_variables(fit1)
# prior_summary(fit1)
# help('prior_summary.stanreg') 


#################
# function to calculate point estimate, 95% CrI, and P(HR>1)
# using prior information
################
eCRP_bayes <- function(data, m_CPR, sd_CPR, m_eCPR, sd_eCPR ) {
  set.seed(1234)
  fit <- stan_glm(prop_success ~ Tx, data = data, family = binomial(link="logit"), weights = total, refresh=0,
                  prior = normal(m_eCPR, sd_eCPR),
                  prior_intercept = normal (m_CPR, sd_CPR))
  fit_sum <- summary(fit, digits=3)
  conf_95 <- c(exp(fit_sum[2]),exp(fit_sum[2]+c(-1,1)*1.96*fit_sum[10]))
  tt <- fit %>%
    spread_draws(`(Intercept)`, `TxeCPR`)
  fig_prob <- sum(tt$TxeCPR>0)/nrow(tt)
  fit_draws <- fit %>% tidybayes::tidy_draws() 
  my_list <- list(fig_prob, conf_95, fit_draws)
  return(my_list)
}

# combined_prior 
# informative priors using 2 previous studies combined
comb_m_CPR <- sum(df1[c(2,3),4]) / (sum(df1[c(2,3),4]) + sum(df1[c(2,3),2])) # proportion previous results for CPR
comb_sd_CPR <- sqrt(comb_m_CPR*(1-comb_m_CPR))                               
comb_m_eCPR <- sum(df1[c(2,3),5]) / (sum(df1[c(2,3),5]) + sum(df1[c(2,3),3])) # proportion previous results for eCPR
comb_sd_eCPR <- sqrt(comb_m_eCPR*(1-comb_m_eCPR))
comb_prior <- eCRP_bayes(df[c(1:2),], comb_m_CPR, comb_sd_CPR, comb_m_eCPR, comb_sd_eCPR) #stan_glm with combined prior

# enthusiastic prior with only ARREST study
enth_m_CPR <- sum(df1[c(2),4]) + 1 / (sum(df1[c(2),4]) + sum(df1[c(2),2])) # proportion previous results for CPR, + 0.5 to avoid 0 cell
enth_sd_CPR <- sqrt(enth_m_CPR*(1-enth_m_CPR))
enth_m_eCPR <- sum(df1[c(2),5]) / (sum(df1[c(2),5]) + sum(df1[c(2),3])) # proportion previous results for eCPR
enth_sd_eCPR <- sqrt(enth_m_eCPR*(1-enth_m_eCPR))
enth_prior <- eCRP_bayes(df[c(1:2),], enth_m_CPR, enth_sd_CPR, enth_m_eCPR, enth_sd_eCPR) #stan_glm with enthusiastic prior

# skeptical prior with only PRAGUE study
skep_m_CPR <- sum(df1[c(3),4])  / (sum(df1[c(3),4]) + sum(df1[c(3),2])) # proportion previous results for CPR
skep_sd_CPR <- sqrt(skep_m_CPR*(1-skep_m_CPR))
skep_m_eCPR <- sum(df1[c(3),5]) / (sum(df1[c(3),5]) + sum(df1[c(3),3])) # proportion previous results for eCPR
skep_sd_eCPR <- sqrt(skep_m_eCPR*(1-skep_m_eCPR))
skep_prior <- eCRP_bayes(df[c(1:2),], skep_m_CPR, skep_sd_CPR, skep_m_eCPR, skep_sd_eCPR) #stan_glm with skeptical prior

# skep_prior <- eCRP_bayes(df[c(1:2),], enth_m_CPR, enth_sd_CPR, skep_m_eCPR, skep_sd_eCPR) #test to see impact of enth intercept


table_tbl <- 
  tibble(
    prior = c("vague", "combined", "enthusiastic", "skeptical"),
    pt_est <- c(conf_95[1], comb_prior[[2]][1], enth_prior[[2]][1], skep_prior[[2]][1]),
    llimit <- c(conf_95[2], comb_prior[[2]][2], enth_prior[[2]][2], skep_prior[[2]][2]),
    ulimit <- c(conf_95[3], comb_prior[[2]][3], enth_prior[[2]][3], skep_prior[[2]][3]),
    p.gt.1 <- c(fig_prob, comb_prior[1], enth_prior[1], skep_prior[1])
  )

gt(table_tbl) %>%
  tab_stubhead(label = "Priors") 
```

# **Summary of what I don't understand**

This makes only partial sense. 95% CrI are narrower with informative priors. OK, but one would think the enthusiastic prior from a trial ARREST that was stopped prematurely for benefit 6/15 vs 0/14 successes for eCPR vs CPR would shift the HR of 1.32 to the right but instead the HR falls to have a 1.27. The skeptical prior from PRAGUE which was stopped for futility (38/124 vs 24/132) does shift HR down 1.25 as expected    

So enthusiastic priors - intercept N(.03,.18), Tx N(0.429,0.495)    
skeptical prior - intercept N(.182,.386), Tx N(0.306,0.461)     

Tx for enthusiastic prior > Tx skeptical prior (eCPR) but this seems to be offset by the reverse occurring for the intercept (CPR).     
The problem seems to be in how comparable are these previous RCTs as the baseline success for the standard TX (CRP) is radically different 0/14 vs 24/132.    

When I use a prior that uses the enthusiastic intercept prior and the skeptical Tx prior, I  get a bigger downward shift with HR 1.220 95% CrI(0.678 2.194) and P>1 74.5%

Can you see any other explanation?    

Do you have any other insights?

Update 2023/02/07
Might make most sense to interpret the INCEPTION trial based on the baseline CPR risk observed in that trial and provide informative priors only for the Tx variable (enthusiastic from ARREST, skeptical from PRAGUE)

# Bayesian prior analysis #2
```{r}
## try re-running using prior for eCPR from different studies but leaving CPR with vague prior since baseline risks with CPR seem to vary
## widely btw the different studies

eCRP_bayes_no_intercept_prior <- function(data, m_eCPR, sd_eCPR ) {
  set.seed(1234)
  fit <- stan_glm(prop_success ~ Tx, data = data, family = binomial(link="logit"), weights = total, refresh=0,
                  prior = normal(m_eCPR, sd_eCPR))
  fit_sum <- summary(fit, digits=3)
  conf_95 <- c(exp(fit_sum[2]),exp(fit_sum[2]+c(-1,1)*1.96*fit_sum[10]))
  tt <- fit %>%
    spread_draws(`(Intercept)`, `TxeCPR`)
  fig_prob <- sum(tt$TxeCPR>0)/nrow(tt)
  fit_draws <- fit %>% tidybayes::tidy_draws() 
  my_list <- list(fig_prob, conf_95, fit_draws)
  return(my_list)
}

comb_prior1 <-eCRP_bayes_no_intercept_prior(df[c(1:2),], comb_m_eCPR, comb_sd_eCPR) #stan_glm with combined prior
enth_prior1 <- eCRP_bayes_no_intercept_prior(df[c(1:2),], enth_m_eCPR, enth_sd_eCPR) #stan_glm with enthusiastic prior
skep_prior1 <- eCRP_bayes_no_intercept_prior(df[c(1:2),], skep_m_eCPR, skep_sd_eCPR) #stan_glm with skeptical prior

table_tbl_1 <- 
  tibble(
    prior = c("vague", "combined", "enthusiastic", "skeptical"),
    pt_est <- c(conf_95[1], comb_prior1[[2]][1], enth_prior1[[2]][1], skep_prior1[[2]][1]),
    llimit <- c(conf_95[2], comb_prior1[[2]][2], enth_prior1[[2]][2], skep_prior1[[2]][2]),
    ulimit <- c(conf_95[3], comb_prior1[[2]][3], enth_prior1[[2]][3], skep_prior1[[2]][3]),
    p.gt.1 <- c(fig_prob, comb_prior[1], enth_prior[1], skep_prior[1])
  )

gt(table_tbl_1) %>%
  tab_stubhead(label = "Priors") 
```

This seems like a reasonable solution

# Figures

```{r warning=FALSE, message=FALSE}

#############
# function to plot probability function
#############

plot_bayes <- function(data,text1,text2, fig_prob=.5){
  annon <- paste0(text2, fig_prob*100, "%")
  ggplot(data, aes(x = exp(TxeCPR),
                   fill = after_stat(x > 1),
                   slab_alpha = after_stat((x)))
  ) +
    ggdist::stat_halfeye() +
    scale_x_continuous(name=text, limits=c(0, 4)) +
    scale_y_continuous(name="Density") +
    labs(title = text1) +
    annotate(geom="text", x=2.75,y=.6, label = annon) +
    theme_classic() +
    theme(legend.position="none") 
}

#plot combined prior
#text1 <-c("HR increased survival with extracorporeal CPR")
#text2 <- c("Probability of increased survival \n(with intact neurological status) \nwith extracorporeal CPR >")
#plot_bayes(comb_prior[[3]], text1, text2, comb_prior[[1]])


fit1 %>% tidybayes::tidy_draws() |> 
  ggplot(aes(x = exp(TxeCPR),
             fill = after_stat(x > 1),
             slab_alpha = after_stat((x)))
  ) +
  ggdist::stat_halfeye() +
  scale_x_continuous(name="HR being alive with extracorporeal CPR", limits=c(0, 5)) +
  scale_y_continuous(name="Density") +
  labs(title = "Figure 1 INCEPTION ITT analysis with vague prior") +
  annotate(geom="text", x=2.75,y=.6, label = "Probability of increased survival \n(with intact neurological status) \nwith extracorporeal CPR = 72.7%") +
  theme_classic() +
  theme(legend.position="none") 



```

\newpage

# References {.unnumbered}
